{% extends "layout.html" %}

{% block Body %}

<div class="col-md-12 invisibile" id="caricaPlugin">
  <div class="card ombra">
    <div class="card-body">
      {{ 'inizio' | startForm('/private/super-admin/upload-plugin', 'false') | raw }}

      {{ upload | raw }}

      <div class="col-md-12">
        <button type="submit" class="btn btn-outline-info">Carica Plug-in</button>
      </div>
      {{ 'fine' | startForm() | raw }}
    </div>
  </div>
</div>


<div class="col-md-12">
  <div class="card ombra">
    <div class="card-body">
      <div class="row">
        <table class="table table-bordered" id="plugin-table">
          <thead>
            <tr>
              <th>Plugin</th>
              <th>Descrizione</th>
              <th>Status</th>
              <th>Azioni</th>
            </tr>
          </thead>
          <tfoot>
            <tr>
              <th>Plugin</th>
              <th>Descrizione</th>
              <th>Status</th>
              <th class="noInput">Azioni</th>
            </tr>
          </tfoot>
          <tbody>
            {% for p in plugins %}
            {% if p.label != 'Header Menu' %}
            <tr>
              <td>
                {{ p.label }}<br>

                <a href="javascript:void(0)" onclick="EliminaPlugin('{{ p.name }}')"><small
                    class="text-danger">Elimina</small></a>

              </td>
              <td>
                <small class="text-muted">
                  Versione <span class="text-info"><u>{{ p.version }}</u></span>
                </small>
                <p class="mt-2 mb-0 text-muted small">
                  {{ p.description }}
                </p>
              </td>
              <td>
                {% if p.active %}
                <span class="text-success"><u>Attivo</u></span>
                {% else %}
                <span class="text-secondary"><u>Disattivato</u></span>
                {% endif %}
              </td>
              <td>
                <div class="form-check form-switch">
                  <input class="form-check-input plugin-toggle" type="checkbox" data-plugin="{{ p.name }}" {% if
                    p.active %}checked{% endif %}>
                </div>
              </td>
            </tr>
            {% endif %}
            {% endfor %}
          </tbody>
        </table>

      </div>
    </div>

  </div>
</div>

{% endblock %}
{% block Script %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    let btn = document.getElementById('btn-add-dynamic');
    btn.innerHTML = `<a href="javascript:void(0)" class="text-success" onclick="ShowChargePlugin()"><i class="fas fa-plus"></i>&nbsp; Aggiungi</a>`;
    CaricaTabella('plugin-table');
    document.getElementsByClassName('page-title-main').innerHTML = "{{ Titolo ?? '' }}";
    document.querySelectorAll('.plugin-toggle').forEach(toggle => {

      toggle.addEventListener('change', function () {

        const plugin = this.dataset.plugin;
        const active = this.checked ? 1 : 0;
        const checkbox = this;

        Swal.fire({
          title: active ? 'Attivare plugin?' : 'Disattivare plugin?',
          text: `Vuoi davvero ${active ? 'attivare' : 'disattivare'} il plugin "${plugin}"?`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'SÃ¬',
          cancelButtonText: 'Annulla'
        }).then(result => {

          if (!result.isConfirmed) {
            checkbox.checked = !checkbox.checked;
            return;
          }

          AjaxHelper.post('/private/super-admin/toggle-plugin-ajax', {
            plugin: plugin,
            active: active
          }, {}, false)
            .then(res => {

              console.log(res);

              if (res.data.status !== 'ok') {
                Swal.fire(
                  'Errore',
                  res.error ?? 'Errore durante lâ€™operazione',
                  'error'
                );
                checkbox.checked = !checkbox.checked;
                return;
              }

              Swal.fire(
                'OK',
                'Operazione completata',
                'success'
              ).then(() => {
                if (res.data.reload) {
                  location.reload();
                }
              });

            })
            .catch(() => {
              Swal.fire(
                'Errore',
                'Errore di comunicazione con il server',
                'error'
              );
              checkbox.checked = !checkbox.checked;
            });

        });
      });
    });
  });

  function ShowChargePlugin() {
    const box = document.getElementById('caricaPlugin');

    if (!box) return;

    const isHidden = box.classList.contains('invisibile');

    if (isHidden) {
      box.classList.remove('invisibile');
    } else {
      box.classList.add('invisibile');
    }
  }
  function EliminaPlugin(nomePlugin) {

    Swal.fire({
      title: 'Eliminare plugin?',
      text: `Il plugin "${nomePlugin}" verrÃ  eliminato definitivamente`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      confirmButtonText: 'SÃ¬, elimina',
      cancelButtonText: 'Annulla'
    }).then(result => {

      if (!result.isConfirmed) return;

      AjaxHelper.post(
        '/private/super-admin/delete-plugin',
        {
          plugin: nomePlugin
        }, {}, false
      ).then(res => {

        // ðŸ”Ž risposta standard del tuo framework
        if (!res || res.data.status !== 'ok') {
          Swal.fire(
            'Errore',
            res?.error ?? 'Errore durante eliminazione plugin',
            'error'
          );
          return;
        }

        Swal.fire(
          'Eliminato',
          'Plugin eliminato correttamente',
          'success'
        ).then(() => {
          if (res.data.reload) {
            location.reload();
          }
        });

      }).catch(err => {
        console.error(err);
        Swal.fire(
          'Errore',
          'Errore di comunicazione con il server',
          'error'
        );
      });

    });
  }
</script>
{% endblock %}