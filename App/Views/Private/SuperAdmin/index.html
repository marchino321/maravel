{% extends 'layout.html' %}
{% block title %} {{ Titolo }} {% endblock %}

{% block Body %}
<style>
  .header-success {
    background: linear-gradient(135deg, #16c469, #2dd88f);
    color: #fff;
  }

  .header-primary {
    background: linear-gradient(135deg, #71b6f9, #4a9df8);
    color: #fff;
  }

  .card {
    border-radius: 10px;
    box-shadow: 0 6px 18px rgba(0, 0, 0, .08);
    border: none;
  }

  .card-header {
    font-weight: 600;
    letter-spacing: .5px;
    padding: 12px 16px;
  }

  .stat-card {
    text-align: center;
    padding: 18px 10px;
  }

  .stat-card .value {
    font-size: 1.4rem;
    font-weight: 700;
  }

  .stat-card .label {
    font-size: .8rem;
    text-transform: uppercase;
    opacity: .8;
  }

  .system-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .system-list li {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    border-bottom: 1px dashed rgba(0, 0, 0, .1);
    font-size: .9rem;
  }

  .system-list li:last-child {
    border-bottom: none;
  }

  .table thead th {
    background: #f5f7fa;
    text-transform: uppercase;
    font-size: .75rem;
  }

  .log {
    border: 2px solid #000;
    background-color: #191b19;
    padding: 10px;
    border-radius: 10px;
    box-shadow: 10px 20px 30px rgba(0, 0, 0, .9);
  }
</style>
<div class="row">
  <div class="col-md-3 form-group">
    <div class="card">
      <div class="card-header text-success text-uppercase">
        Debug Console
      </div>
      <div class="card-body stat-card">
        <select id="debugToggle" class="form-select">
          <option value="1" {% if DEBUG_CONSOLE %}selected{% endif %}>
            üü¢ Attivo
          </option>
          <option value="0" {% if not DEBUG_CONSOLE %}selected{% endif %}>
            üî¥ Disattivo
          </option>
        </select>
        <div class="label mt-2">{% if not DEBUG_CONSOLE %} Console Debug {% else %} {{ __('apri.console.log') }} {%
          endif %} </div>
      </div>
    </div>
  </div>

  <div class="col-md-3 form-group">
    <div class="card">
      <div class="card-header text-info text-uppercase">
        Traduzione
      </div>
      <div class="card-body stat-card">
        <div class="value">üåç {{ currentLang|upper }}</div>
        <div class="label  text-info">
          {{ availableLangs|length }} lingue attive
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3 form-group">
    <div class="card">
      <div class="card-header text-warning text-uppercase">
        Theme
      </div>
      <div class="card-body stat-card">
        <div class="value">
          {{ 'inizio' | startForm('/private/super-admin/switch-theme', 'false') | raw }}
          <select name="theme" class="form-select form-select-sm" onchange="this.form.submit()">
            <option value="">
              [ SCEGLI UN THEMA ]
            </option>
            {% for theme in availableThemes %}
            <option value="{{ theme }}" {% if theme==currentTheme %}selected{% endif %}>
              {{ theme|capitalize }}
            </option>
            {% endfor %}
          </select>


          {{ 'fine' | startForm() | raw }}
        </div>

        <div class="mt-1"><span class="text-warning">Tema attivo</span> (<span class="text-success">{{currentTheme
            |capitalize}}</span>)
        </div>
      </div>
    </div>
  </div>


  <div class="col-md-3 form-group">
    <div class="card">
      <div class="card-header text-danger text-uppercase">
        Plug-in
      </div>
      <div class="card-body stat-card">
        <div class="value">{{ plugin_count - 1 | default(0) }}</div>
        <div class="label text-danger">Plugin attivi</div>
        <ul class="list-group list-group-flush">
          {% for plugin in pluginList %}
          {% if plugin.name != 'HeaderMenu' %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>
              üß© {{ plugin.name }}
            </span>
            <div class="form-check form-switch">
              <input class="form-check-input plugin-toggle" type="checkbox" data-plugin="{{ plugin.name }}" {% if
                plugin.config.active %}checked{% endif %}>
            </div>
          </li>
          {% endif %}
          {% else %}
          <li class="list-group-item text-muted">
            Nessun plugin attivo
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

</div>
<div class="row">

  <div class="col-lg-6">
    <div class="card">
      <div class="card-header text-primary text-uppercase">
        Informazioni Sistema
      </div>
      <div class="card-body" style="height:400px; overflow:auto;">
        <ul class="system-list">
          <li><span>VPS</span><strong>{{ data.Nome_Host }} {{ Server_Software }}</strong></li>
          <li><span>OS</span><strong>{{ data.Sistema_Operativo }}</strong></li>
          <li><span>Disco Totale</span><strong>{{ data.Disco_Totale }}</strong></li>
          <li><span>Disco Usato</span><strong>{{ data.Disco_Usato }}</strong></li>
          <li><span>Disco Libero</span><strong>{{ data.Disco_Libero }}</strong></li>
          <li><span>RAM Totale</span><strong>{{ data.RAM_Totale }}</strong></li>
          <li><span>RAM Usata</span><strong>{{ data.RAM_Usata }}</strong></li>
          <li><span>RAM Libera</span><strong>{{ data.RAM_Libera }}</strong></li>
          <li><span>PHP</span><strong>{{ data.PHP_Versione }}</strong></li>
          <li><span>Architettura</span><strong>{{ data.Architettura }}</strong></li>
          <li><span>IP Server</span><strong>{{ data.IP_Server }}</strong></li>
          <li><span>CPU</span><strong>{{ data.Numero_CPU }}</strong></li>

        </ul>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card mb-3">
      <div class="card-body">

        <h5 class="mb-3">üîÑ Aggiorna Core Framework</h5>

        <form id="buildCoreForm" class="row">
          <div class="col-md-12">
            <div class="input-group mb-2">
              <input type="text" name="version" id="version" class="form-control" placeholder="Versione es. 1.0.1"
                required value="{{ core_version }}">
              <button class="btn btn-success" type="submit">
                üöÄ Genera core.json
              </button>
            </div>
          </div>
          {% if last_update %}
          <div class="mt-1 text-muted" style="font-size:.85rem;">
            ‚è± Ultimo aggiornamento:
            <span class="text-info">{{ last_update | noDate }}</span>
          </div>
          {% endif %}


      </div>
      </form>

      <pre id="buildCoreOutput" class="text-success p-3 rounded d-none" style="max-height:300px; overflow:auto;"></pre>

    </div>
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="mb-2">üêû Live Debug Console</h5>



        {% if DEBUG_CONSOLE %}
        <div class="text-muted mb-2" style="font-size:.85rem; line-height:1.4;">
          üß† Questa console di debug √® attiva globalmente quando il debug √® abilitato.<br>
          üì§ I log vengono inviati automaticamente alla console del browser (F12),<br>
          üß© cos√¨ da facilitare l‚Äôanalisi senza interferire con il layout o l‚Äôesperienza utente.
        </div>
        <div class="log">


          <div class="p-2 rounded" style="height:250px; overflow:auto; font-size:.8rem;">

            {% for log in debug_output %}
            <span style="color: {{ log.color }};">
              {{ log.emoji }} {{ log.tag }} {{ log.message }}
            </span><br>
            {% else %}
            <span class="text-muted">Nessun log disponibile</span>
            {% endfor %}

          </div>
          {% else %}
          <div class="text-muted">
            üîí Debug disattivato
          </div>
        </div>
        {% endif %}

      </div>
    </div>
  </div>
</div>
</div>



{% endblock %}
{% block Script %}
<script>
  document.getElementById('buildCoreForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const form = this;
    const outputBox = document.getElementById('buildCoreOutput');
    const btn = form.querySelector('button');

    outputBox.classList.remove('d-none');
    outputBox.textContent = "‚è≥ Esecuzione in corso...\n";
    outputBox.classList.remove('text-danger', 'text-success');
    btn.disabled = true;

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    AjaxHelper.post(
      '/private/super-admin/build-core-ajax',
      data,
      {},
      false // niente loader globale
    )
      .then(response => {

        if (!response || typeof response !== 'object') {
          throw 'Risposta non valida dal server';
        }

        if (response.data.status === 'ok') {
          outputBox.textContent = response.data.output || '‚úÖ Operazione completata correttamente';
          outputBox.classList.remove('text-danger');
          outputBox.classList.add('text-success');
        } else {
          outputBox.textContent = response.data.output || '‚ùå Errore durante l‚Äôoperazione';
          outputBox.classList.remove('text-success');
          outputBox.classList.add('text-danger');
        }

      })
      .catch(error => {
        outputBox.textContent = "‚ùå Errore AJAX\n" + error;
        outputBox.classList.add('text-danger');
      })
      .finally(() => {
        btn.disabled = false;
      });
  });

  document.getElementById('debugToggle').addEventListener('change', function () {
    const value = this.value;

    AjaxHelper.post(
      '/private/super-admin/toggle-debug-ajax',
      { debug: value },
      {},
      false
    )
      .then(response => {
        if (response?.data?.status === 'ok') {
          location.href = "?update=ok";
        } else {
          alert('Errore durante il salvataggio');
        }
      })
      .catch(() => alert('Errore AJAX'));
  });

  document.querySelectorAll('.plugin-toggle').forEach(toggle => {
    toggle.addEventListener('change', function () {
      const plugin = this.dataset.plugin;
      const active = this.checked ? 1 : 0;

      AjaxHelper.post(
        '/private/super-admin/toggle-plugin-ajax',
        { plugin, active },
        {},
        false
      ).then(res => {
        console.log(res);
        if (res?.data?.reload) {
          location.reload();
        }
      }).catch(() => {
        alert('Errore aggiornamento plugin');
        this.checked = !this.checked;
      });
    });
  });
</script>
{% endblock %}